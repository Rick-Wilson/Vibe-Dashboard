<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BridgeDev Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'JetBrains Mono', monospace; }
        .gradient-bg { background: linear-gradient(135deg, #0f172a 0%, #020617 50%, #0f172a 100%); }
        .grid-pattern {
            background-image: linear-gradient(rgba(16, 185, 129, 0.03) 1px, transparent 1px),
                              linear-gradient(90deg, rgba(16, 185, 129, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
        }
        .loading { animation: pulse 2s ease-in-out infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body class="gradient-bg text-slate-100 min-h-screen">
    <div class="grid-pattern fixed inset-0 pointer-events-none"></div>
    
    <!-- Loading State -->
    <div id="loading" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-950">
        <div class="text-center">
            <div class="w-12 h-12 border-4 border-emerald-500/30 border-t-emerald-500 rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-slate-400 loading">Loading dashboard data...</p>
        </div>
    </div>
    
    <!-- Error State -->
    <div id="error" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-950 hidden">
        <div class="text-center max-w-md p-8">
            <div class="text-6xl mb-4">üìä</div>
            <h2 class="text-xl font-bold text-slate-200 mb-2">No Data Found</h2>
            <p class="text-slate-400 mb-4" id="error-message">Could not load dashboard_data.json</p>
            <div class="bg-slate-800/50 rounded-lg p-4 text-left text-sm">
                <p class="text-slate-300 mb-2">To generate data, run:</p>
                <code class="text-emerald-400 block bg-slate-900 p-2 rounded">python fetch_github_data.py --user YOUR_USERNAME</code>
            </div>
            <button onclick="loadDemoData()" class="mt-4 px-4 py-2 bg-emerald-500/20 border border-emerald-500/30 text-emerald-400 rounded-lg hover:bg-emerald-500/30 transition-all text-sm">
                Load Demo Data Instead
            </button>
        </div>
    </div>
    
    <div id="app" class="relative z-10 hidden">
        <!-- Header -->
        <header class="border-b border-slate-800/50 backdrop-blur-sm bg-slate-950/80 sticky top-0 z-20">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="p-2 bg-emerald-500/10 rounded-lg border border-emerald-500/20">
                            <svg class="w-6 h-6 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                            </svg>
                        </div>
                        <div>
                            <h1 class="text-xl font-bold tracking-tight">
                                <span class="text-emerald-400">Bridge</span><span class="text-slate-400">Dev</span><span class="text-slate-600">.dashboard</span>
                            </h1>
                            <p class="text-xs text-slate-500 mt-0.5">Project Analytics & Progress Tracker</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-4">
                        <span class="text-xs text-slate-500" id="last-updated"></span>
                        <select id="repo-filter" onchange="applyFilters()" class="bg-slate-900/50 border border-slate-800/50 rounded-lg px-3 py-2 text-sm text-slate-300 focus:outline-none focus:border-emerald-500/50">
                            <option value="all">All Repos</option>
                        </select>
                        <nav class="flex gap-1 bg-slate-900/50 p-1 rounded-lg border border-slate-800/50">
                            <button onclick="showTab('overview')" class="tab-btn px-4 py-2 rounded-md text-sm transition-all active" data-tab="overview">Overview</button>
                            <button onclick="showTab('projects')" class="tab-btn px-4 py-2 rounded-md text-sm transition-all" data-tab="projects">Projects</button>
                            <button onclick="showTab('activity')" class="tab-btn px-4 py-2 rounded-md text-sm transition-all" data-tab="activity">Activity</button>
                            <button onclick="showTab('claude')" class="tab-btn px-4 py-2 rounded-md text-sm transition-all" data-tab="claude">Claude</button>
                        </nav>
                    </div>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-6 py-8">
            <!-- Overview Tab -->
            <div id="tab-overview" class="tab-content space-y-8">
                <div class="grid grid-cols-4 gap-4" id="stats-grid"></div>
                <div class="grid grid-cols-3 gap-6">
                    <div class="col-span-2 bg-slate-900/50 border border-slate-800/50 rounded-xl p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-sm font-medium text-slate-400">Commit Activity</h3>
                            <select id="commit-timeframe" onchange="applyFilters()" class="bg-slate-800/50 border border-slate-700/50 rounded-lg px-2 py-1 text-xs text-slate-400 focus:outline-none focus:border-emerald-500/50">
                                <option value="30">30 days</option>
                                <option value="60">60 days</option>
                                <option value="90" selected>90 days</option>
                            </select>
                        </div>
                        <canvas id="commitChart" height="100"></canvas>
                    </div>
                    <div class="bg-slate-900/50 border border-slate-800/50 rounded-xl p-6">
                        <h3 class="text-sm font-medium text-slate-400 mb-4">Language Distribution</h3>
                        <canvas id="languageChart" height="200"></canvas>
                    </div>
                </div>
                <div class="bg-slate-900/50 border border-slate-800/50 rounded-xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-sm font-medium text-slate-400">Codebase Growth</h3>
                        <select id="growth-timeframe" onchange="applyFilters()" class="bg-slate-800/50 border border-slate-700/50 rounded-lg px-2 py-1 text-xs text-slate-400 focus:outline-none focus:border-emerald-500/50">
                            <option value="3">3 months</option>
                            <option value="6">6 months</option>
                            <option value="12" selected>12 months</option>
                        </select>
                    </div>
                    <canvas id="growthChart" height="80"></canvas>
                </div>
                <div>
                    <h3 class="text-sm font-medium text-slate-400 mb-4">Project Progress</h3>
                    <div class="grid grid-cols-2 gap-4" id="project-cards"></div>
                </div>
            </div>

            <!-- Projects Tab -->
            <div id="tab-projects" class="tab-content hidden space-y-6">
                <div id="projects-list" class="space-y-4"></div>
                <div id="project-detail" class="hidden"></div>
            </div>

            <!-- Activity Tab -->
            <div id="tab-activity" class="tab-content hidden space-y-6">
                <div class="bg-slate-900/50 border border-slate-800/50 rounded-xl p-6">
                    <h3 class="text-sm font-medium text-slate-400 mb-4">Contribution Calendar (90 days)</h3>
                    <div id="contribution-calendar" class="flex flex-wrap gap-1"></div>
                    <div class="flex items-center gap-2 mt-4 text-xs text-slate-500">
                        <span>Less</span>
                        <div class="w-3 h-3 rounded-sm bg-slate-800"></div>
                        <div class="w-3 h-3 rounded-sm bg-emerald-900"></div>
                        <div class="w-3 h-3 rounded-sm bg-emerald-700"></div>
                        <div class="w-3 h-3 rounded-sm bg-emerald-500"></div>
                        <div class="w-3 h-3 rounded-sm bg-emerald-400"></div>
                        <span>More</span>
                    </div>
                </div>
                <div class="bg-slate-900/50 border border-slate-800/50 rounded-xl p-6">
                    <h3 class="text-sm font-medium text-slate-400 mb-4">Recent Project Activity</h3>
                    <div id="recent-activity" class="space-y-3"></div>
                </div>
            </div>

            <!-- Claude Tab -->
            <div id="tab-claude" class="tab-content hidden space-y-6">
                <!-- Claude Stats Grid -->
                <div class="grid grid-cols-4 gap-4" id="claude-stats-grid"></div>

                <!-- Claude Activity Chart -->
                <div class="bg-slate-900/50 border border-slate-800/50 rounded-xl p-6">
                    <h3 class="text-sm font-medium text-slate-400 mb-4">Claude Usage Over Time</h3>
                    <canvas id="claudeActivityChart" height="100"></canvas>
                </div>

                <!-- Claude Heatmap -->
                <div class="bg-slate-900/50 border border-slate-800/50 rounded-xl p-6">
                    <h3 class="text-sm font-medium text-slate-400 mb-4">Activity Heatmap</h3>
                    <div id="claude-heatmap" class="grid gap-2"></div>
                    <div class="flex items-center gap-2 mt-4 text-xs text-slate-500">
                        <span>Less</span>
                        <div class="w-3 h-3 rounded-sm bg-slate-800"></div>
                        <div class="w-3 h-3 rounded-sm bg-violet-900"></div>
                        <div class="w-3 h-3 rounded-sm bg-violet-700"></div>
                        <div class="w-3 h-3 rounded-sm bg-violet-500"></div>
                        <div class="w-3 h-3 rounded-sm bg-violet-400"></div>
                        <span>More</span>
                    </div>
                </div>

                <!-- Hourly Distribution -->
                <div class="bg-slate-900/50 border border-slate-800/50 rounded-xl p-6">
                    <h3 class="text-sm font-medium text-slate-400 mb-4">Hourly Activity Distribution</h3>
                    <canvas id="claudeHourlyChart" height="60"></canvas>
                </div>
            </div>

        </main>
    </div>

    <script>
        // Global state
        let dashboardData = null;
        let claudeData = null;
        let charts = {};
        let currentFilters = {
            repo: 'all',
            commitDays: 90,
            growthMonths: 12
        };

        // URL parameter helpers
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                repo: params.get('repo') || 'all',
                commitDays: parseInt(params.get('days')) || 90,
                growthMonths: parseInt(params.get('months')) || 12,
                tab: params.get('tab') || 'overview'
            };
        }

        function updateUrlParams(tab = null) {
            const params = new URLSearchParams();
            if (currentFilters.repo !== 'all') params.set('repo', currentFilters.repo);
            if (currentFilters.commitDays !== 90) params.set('days', currentFilters.commitDays);
            if (currentFilters.growthMonths !== 12) params.set('months', currentFilters.growthMonths);
            if (tab && tab !== 'overview') params.set('tab', tab);

            const newUrl = params.toString()
                ? `${window.location.pathname}?${params.toString()}`
                : window.location.pathname;
            history.replaceState(null, '', newUrl);
        }

        function initFiltersFromUrl() {
            const urlParams = getUrlParams();
            currentFilters.repo = urlParams.repo;
            currentFilters.commitDays = urlParams.commitDays;
            currentFilters.growthMonths = urlParams.growthMonths;

            // Set dropdown values
            document.getElementById('commit-timeframe').value = currentFilters.commitDays;
            document.getElementById('growth-timeframe').value = currentFilters.growthMonths;

            // Set tab from URL (will be applied after data loads)
            if (urlParams.tab && ['overview', 'projects', 'activity', 'claude'].includes(urlParams.tab)) {
                setTimeout(() => showTab(urlParams.tab), 0);
            }
        }
        
        const LANG_COLORS = {
            Python: '#3776ab', TypeScript: '#3178c6', JavaScript: '#f7df1e',
            'C#': '#68217a', Java: '#b07219', Go: '#00ADD8', Rust: '#dea584',
            Ruby: '#701516', PHP: '#4F5D95', HTML: '#e34c26', CSS: '#264de4',
            Markdown: '#083fa1', Shell: '#89e051', 'C++': '#f34b7d', C: '#555555',
            JSON: '#5a9e6f', SVG: '#ff6600', TOML: '#9c4121', YAML: '#cb171e',
            SQL: '#e38c00', Vue: '#41b883', TeX: '#3d6117', Lua: '#000080',
            Kotlin: '#A97BFF', Swift: '#F05138', Dart: '#00B4AB', Scala: '#c22d40',
            R: '#198CE7', Perl: '#0298c3', Haskell: '#5e5086', Elixir: '#6e4a7e',
            Lex: '#DBCA00', Happy: '#5e5086', Pest: '#646464', INI: '#d1dbe0',
            PowerShell: '#012456', Batch: '#C1F12E', VBScript: '#15dcdc',
            'Visual Basic': '#945db7', 'C Header': '#438eff', MSBuild: '#178600',
            Makefile: '#427819'
        };

        // Load data from JSON file
        async function loadData() {
            try {
                const response = await fetch('dashboard_data.json');
                if (!response.ok) throw new Error('File not found');
                dashboardData = await response.json();

                // Also try to load Claude data
                await loadClaudeData();

                showApp();

                // Fetch live releases in background (won't block initial render)
                fetchLiveReleases();
            } catch (error) {
                console.log('Could not load dashboard_data.json:', error);
                showError(error.message);
            }
        }

        async function loadClaudeData() {
            try {
                const response = await fetch('claude_stats.json');
                if (response.ok) {
                    claudeData = await response.json();
                }
            } catch (error) {
                console.log('Claude stats not available:', error);
                claudeData = null;
            }
        }

        // Live releases from GitHub Events API
        const RELEASES_CACHE_KEY = 'vibe_dashboard_releases';
        const RELEASES_CACHE_TTL = 60 * 60 * 1000; // 1 hour
        const GITHUB_USER = 'Rick-Wilson';

        async function fetchLiveReleases() {
            try {
                // Check cache first
                const cached = localStorage.getItem(RELEASES_CACHE_KEY);
                if (cached) {
                    const { timestamp, releases } = JSON.parse(cached);
                    if (Date.now() - timestamp < RELEASES_CACHE_TTL) {
                        console.log('Using cached releases');
                        mergeLiveReleases(releases);
                        return;
                    }
                }

                // Fetch from GitHub Events API
                console.log('Fetching live releases from GitHub...');
                const response = await fetch(`https://api.github.com/users/${GITHUB_USER}/received_events?per_page=100`);

                if (!response.ok) {
                    if (response.status === 403) {
                        console.log('GitHub API rate limited, using cached/static data');
                    }
                    return;
                }

                const events = await response.json();

                // Filter for release and tag creation events
                const releaseEvents = events.filter(e =>
                    e.type === 'ReleaseEvent' ||
                    (e.type === 'CreateEvent' && e.payload.ref_type === 'tag')
                );

                const liveReleases = releaseEvents.map(e => {
                    if (e.type === 'ReleaseEvent') {
                        return {
                            tag: e.payload.release.tag_name,
                            date: e.payload.release.published_at || e.created_at,
                            repo: e.repo.name.split('/')[1],
                            message: e.payload.release.name || e.payload.release.tag_name,
                            live: true
                        };
                    } else {
                        return {
                            tag: e.payload.ref,
                            date: e.created_at,
                            repo: e.repo.name.split('/')[1],
                            message: e.payload.ref,
                            live: true
                        };
                    }
                });

                // Cache the results
                localStorage.setItem(RELEASES_CACHE_KEY, JSON.stringify({
                    timestamp: Date.now(),
                    releases: liveReleases
                }));

                mergeLiveReleases(liveReleases);

            } catch (error) {
                console.log('Could not fetch live releases:', error);
            }
        }

        function mergeLiveReleases(liveReleases) {
            if (!liveReleases || liveReleases.length === 0) return;

            const staticReleases = dashboardData.releases || [];

            // Create a map of existing releases by repo+tag to avoid duplicates
            const existingKeys = new Set(staticReleases.map(r => `${r.repo}:${r.tag}`));

            // Add new live releases that don't exist in static data
            const newReleases = liveReleases.filter(r => !existingKeys.has(`${r.repo}:${r.tag}`));

            if (newReleases.length > 0) {
                // Merge and sort by date (newest first)
                dashboardData.releases = [...newReleases, ...staticReleases]
                    .sort((a, b) => new Date(b.date) - new Date(a.date));

                console.log(`Added ${newReleases.length} live releases`);

                // Re-render stats to show updated releases
                renderStats();
            }
        }

        function loadDemoData() {
            // Generate demo data
            dashboardData = generateDemoData();
            document.getElementById('error').classList.add('hidden');
            showApp();
        }

        function generateDemoData() {
            const projects = [
                { id: 1, name: 'bridge-bidding-trainer', full_name: 'user/bridge-bidding-trainer', description: 'Interactive bidding practice with AI opponents', language: 'Python', stars: 12, progress: 75, goals: ['Core bidding engine', 'AI opponent logic', 'Web interface', 'Hand generation'], completed_goals: ['Core bidding engine', 'AI opponent logic', 'Hand generation'], loc: { Python: 4200, JavaScript: 1800, HTML: 450, CSS: 320 }, commits: 127, last_commit: new Date(Date.now() - 2*86400000).toISOString(), url: '#' },
                { id: 2, name: 'deal-analyzer', full_name: 'user/deal-analyzer', description: 'Post-mortem analysis of bridge deals', language: 'TypeScript', stars: 8, progress: 45, goals: ['PBN parser', 'Double dummy solver', 'Visualization', 'Export reports'], completed_goals: ['PBN parser', 'Double dummy solver'], loc: { TypeScript: 3100, JavaScript: 890, CSS: 280 }, commits: 89, last_commit: new Date(Date.now() - 86400000).toISOString(), url: '#' },
                { id: 3, name: 'tournament-manager', full_name: 'user/tournament-manager', description: 'Swiss and round-robin tournament scoring', language: 'C#', stars: 5, progress: 30, goals: ['Scoring algorithms', 'Pairing engine', 'Results display', 'BridgeMate integration', 'Web dashboard'], completed_goals: ['Scoring algorithms'], loc: { 'C#': 2800, JavaScript: 1200, HTML: 380, CSS: 190 }, commits: 64, last_commit: new Date(Date.now() - 5*86400000).toISOString(), url: '#' },
                { id: 4, name: 'pdf-handout', full_name: 'user/pdf-handout', description: 'Add headers/footers to PDF bridge handouts', language: 'Python', stars: 3, progress: 85, goals: ['PDF parsing', 'Header/footer injection', 'Remove existing headers', 'CLI interface'], completed_goals: ['PDF parsing', 'Header/footer injection', 'Remove existing headers', 'CLI interface'], loc: { Python: 1450, Markdown: 120 }, commits: 42, last_commit: new Date(Date.now() - 3*3600000).toISOString(), url: '#' }
            ];

            const commitHistory = [];
            for (let i = 89; i >= 0; i--) {
                const date = new Date(Date.now() - i * 86400000);
                const dayOfWeek = date.getDay();
                const base = dayOfWeek === 0 || dayOfWeek === 6 ? 1 : 3;
                const commits = Math.floor(Math.random() * base * 2);
                commitHistory.push({ date: date.toISOString().split('T')[0], commits, additions: commits * 40, deletions: commits * 10 });
            }

            const locHistory = [];
            let totalLoc = 8000;
            for (let i = 11; i >= 0; i--) {
                const date = new Date();
                date.setMonth(date.getMonth() - i);
                totalLoc += Math.floor(Math.random() * 800 + 200);
                locHistory.push({ month: date.toLocaleString('default', { month: 'short' }), loc: totalLoc });
            }

            const languages = {};
            projects.forEach(p => Object.entries(p.loc).forEach(([l, v]) => languages[l] = (languages[l] || 0) + v));

            const thisWeek = commitHistory.slice(-7).reduce((s, d) => s + d.commits, 0);
            const lastWeek = commitHistory.slice(-14, -7).reduce((s, d) => s + d.commits, 0);

            // Sample releases
            const releases = [
                { tag: 'v1.2.0', date: new Date(Date.now() - 2 * 86400000).toISOString(), repo: 'bridge-bidding-trainer', message: 'Added SAYC support' },
                { tag: 'v0.8.1', date: new Date(Date.now() - 5 * 86400000).toISOString(), repo: 'deal-analyzer', message: 'Bug fixes' },
                { tag: 'v0.3.0', date: new Date(Date.now() - 14 * 86400000).toISOString(), repo: 'tournament-manager', message: 'Initial scoring' },
                { tag: 'v1.1.0', date: new Date(Date.now() - 30 * 86400000).toISOString(), repo: 'bridge-bidding-trainer', message: 'Convention cards' },
            ];

            return {
                generated_at: new Date().toISOString(),
                stats: {
                    total_loc: Object.values(languages).reduce((a, b) => a + b, 0),
                    total_commits: projects.reduce((s, p) => s + p.commits, 0),
                    avg_progress: Math.round(projects.reduce((s, p) => s + p.progress, 0) / projects.length),
                    this_week_commits: thisWeek,
                    last_week_commits: lastWeek,
                    week_trend: thisWeek - lastWeek,
                    project_count: projects.length
                },
                languages,
                commit_history: commitHistory,
                loc_history: locHistory,
                projects,
                releases
            };
        }

        function showError(message) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('error-message').textContent = message || 'Could not load dashboard_data.json';
            document.getElementById('error').classList.remove('hidden');
        }

        function showApp() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('error').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            
            if (dashboardData.generated_at) {
                const date = new Date(dashboardData.generated_at);
                document.getElementById('last-updated').textContent = `Updated: ${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
            }
            
            renderAll();
        }

        function renderAll() {
            populateRepoFilter();
            renderStats();
            renderCharts();
            renderProjectCards();
            renderProjectsList();
            renderCalendar();
            renderActivity();
            renderClaudeTab();
        }

        function populateRepoFilter() {
            const select = document.getElementById('repo-filter');
            const projects = dashboardData.projects || [];
            const nonForks = projects.filter(p => !p.is_fork);
            const forks = projects.filter(p => p.is_fork);

            let options = '<option value="all">All Repos</option>';
            options += nonForks.map(p => `<option value="${p.name}">${p.name}</option>`).join('');

            if (forks.length > 0) {
                options += '<option disabled>‚îÄ‚îÄ Forks (no LOC) ‚îÄ‚îÄ</option>';
                options += forks.map(p => `<option value="${p.name}">${p.name}</option>`).join('');
            }

            select.innerHTML = options;

            // Apply URL params after populating (only on first load)
            const urlParams = getUrlParams();
            if (urlParams.repo !== 'all') {
                // Verify the repo exists in the data
                const repoExists = projects.some(p => p.name === urlParams.repo);
                if (repoExists) {
                    select.value = urlParams.repo;
                    currentFilters.repo = urlParams.repo;
                }
            }
        }

        function applyFilters() {
            currentFilters.repo = document.getElementById('repo-filter').value;
            currentFilters.commitDays = parseInt(document.getElementById('commit-timeframe').value);
            currentFilters.growthMonths = parseInt(document.getElementById('growth-timeframe').value);
            // Preserve current tab in URL
            const activeTab = [...document.querySelectorAll('.tab-btn')].find(b => b.classList.contains('text-emerald-400'));
            updateUrlParams(activeTab?.dataset.tab || 'overview');
            renderStats();
            renderCharts();
            renderProjectCards();
            renderCalendar();
        }

        function getFilteredProjects() {
            const projects = dashboardData.projects || [];
            if (currentFilters.repo === 'all') return projects;
            return projects.filter(p => p.name === currentFilters.repo);
        }

        function getFilteredCommitHistory() {
            const allHistory = dashboardData.commit_history || [];
            const filtered = allHistory.slice(-currentFilters.commitDays);

            if (currentFilters.repo === 'all') return filtered;

            // Filter by repo - need to use per-project commit history
            const project = dashboardData.projects.find(p => p.name === currentFilters.repo);
            if (!project || !project.commit_history) return filtered;

            // Match project's commit history to the date range
            const projectHist = project.commit_history || [];
            const dates = filtered.map(d => d.date);
            return dates.map(date => {
                const match = projectHist.find(h => h.date === date);
                return match || { date, commits: 0, additions: 0, deletions: 0 };
            });
        }

        function getFilteredLanguages() {
            if (currentFilters.repo === 'all') {
                return dashboardData.languages || {};
            }
            const project = dashboardData.projects.find(p => p.name === currentFilters.repo);
            return project ? (project.loc || {}) : {};
        }

        function getFilteredLocHistory() {
            const locByRepo = dashboardData.loc_history_by_repo;
            if (!locByRepo || !locByRepo.repos) return null;

            const monthsToShow = currentFilters.growthMonths;
            const startIdx = 12 - monthsToShow;

            let repos = locByRepo.repos;
            if (currentFilters.repo !== 'all') {
                repos = repos.filter(r => r.name === currentFilters.repo);
            }

            return {
                months: locByRepo.months.slice(startIdx),
                repos: repos.map(r => ({
                    name: r.name,
                    data: r.data.slice(startIdx)
                }))
            };
        }

        function getFilteredReleases() {
            let releases = dashboardData.releases || [];

            // Filter by repo if needed
            if (currentFilters.repo !== 'all') {
                releases = releases.filter(r => r.repo === currentFilters.repo);
            }

            // Check for releases in the past week
            const oneWeekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
            const recentReleases = releases.filter(r => new Date(r.date) >= oneWeekAgo);

            // Return recent releases if any, otherwise return most recent overall
            return recentReleases.length > 0 ? recentReleases : releases.slice(0, 5);
        }

        function renderStats() {
            const projects = getFilteredProjects();
            const langs = getFilteredLanguages();
            const commitHist = getFilteredCommitHistory();

            const total_loc = Object.values(langs).reduce((a, b) => a + b, 0);
            const total_commits = projects.reduce((sum, p) => sum + (p.commits || 0), 0);
            const this_week_commits = commitHist.slice(-7).reduce((sum, d) => sum + (d.commits || 0), 0);
            const last_week_commits = commitHist.slice(-14, -7).reduce((sum, d) => sum + (d.commits || 0), 0);
            const week_trend = this_week_commits - last_week_commits;
            const project_count = projects.length;

            // Get releases for display
            const releases = getFilteredReleases();
            const releasesHtml = releases.length > 0
                ? releases.slice(0, 3).map(r => `
                    <div class="flex items-center text-xs gap-2">
                        <a href="${getRepoUrl(r.repo)}" target="_blank" class="text-slate-400 hover:text-emerald-400 truncate flex-shrink-0" style="width: 40%;" title="${r.repo}">${r.repo}</a>
                        <a href="${getReleaseUrl(r.repo, r.tag)}" target="_blank" class="text-amber-400 hover:text-amber-300 truncate flex-shrink-0" style="width: 35%;" title="${r.tag}">${r.tag}</a>
                        <span class="text-slate-600 text-right flex-shrink-0" style="width: 25%;">${formatReleaseDate(r.date)}</span>
                    </div>`).join('')
                : '<p class="text-xs text-slate-600">No releases yet</p>';

            document.getElementById('stats-grid').innerHTML = `
                <div class="bg-slate-900/50 border border-slate-800/50 rounded-xl p-5 hover:border-emerald-500/30 transition-all">
                    <p class="text-xs text-slate-500 uppercase tracking-wider">Total Lines</p>
                    <p class="text-3xl font-bold mt-1 text-emerald-400">${total_loc.toLocaleString()}</p>
                    <p class="text-xs text-slate-600 mt-1">${project_count} project${project_count !== 1 ? 's' : ''}</p>
                </div>
                <div class="bg-slate-900/50 border border-slate-800/50 rounded-xl p-5 hover:border-cyan-500/30 transition-all">
                    <p class="text-xs text-slate-500 uppercase tracking-wider">Total Commits</p>
                    <p class="text-3xl font-bold mt-1 text-cyan-400">${total_commits}</p>
                    <p class="text-xs text-slate-600 mt-1">+${this_week_commits} this week</p>
                </div>
                <div class="bg-slate-900/50 border border-slate-800/50 rounded-xl p-5 hover:border-${week_trend >= 0 ? 'emerald' : 'rose'}-500/30 transition-all">
                    <p class="text-xs text-slate-500 uppercase tracking-wider">Week Trend</p>
                    <p class="text-3xl font-bold mt-1 text-${week_trend >= 0 ? 'emerald' : 'rose'}-400">${week_trend >= 0 ? '+' : ''}${week_trend}</p>
                    <p class="text-xs text-slate-600 mt-1">vs last week</p>
                </div>
                <div class="bg-slate-900/50 border border-slate-800/50 rounded-xl p-5 hover:border-amber-500/30 transition-all">
                    <p class="text-xs text-slate-500 uppercase tracking-wider">Recent Releases</p>
                    <div class="mt-2 space-y-1">
                        ${releasesHtml}
                    </div>
                </div>
            `;
        }

        function renderCharts() {
            // Destroy existing charts
            Object.values(charts).forEach(c => c.destroy());
            charts = {};

            const hist = getFilteredCommitHistory();

            // Commit Activity
            charts.commit = new Chart(document.getElementById('commitChart'), {
                type: 'line',
                data: {
                    labels: hist.map(d => d.date.slice(5)),
                    datasets: [{ label: 'Commits', data: hist.map(d => d.commits), borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', fill: true, tension: 0.4 }]
                },
                options: { responsive: true, plugins: { legend: { display: false } }, scales: { x: { ticks: { color: '#475569', maxTicksLimit: 15 } }, y: { ticks: { color: '#475569' } } } }
            });

            // Language Distribution - group small languages into "Other"
            const langs = getFilteredLanguages();
            const langEntries = Object.entries(langs).sort((a, b) => b[1] - a[1]);
            const totalLoc = langEntries.reduce((sum, [, v]) => sum + v, 0);
            const threshold = 0.03; // 3% threshold for grouping into "Other"

            const mainLangs = [];
            const otherLangs = [];
            let otherTotal = 0;

            langEntries.forEach(([lang, loc]) => {
                const pct = loc / totalLoc;
                if (pct >= threshold) {
                    mainLangs.push([lang, loc]);
                } else {
                    otherLangs.push([lang, loc, (pct * 100).toFixed(1)]);
                    otherTotal += loc;
                }
            });

            // Add "Other" category if there are small languages
            const chartData = [...mainLangs];
            if (otherLangs.length > 0) {
                chartData.push(['Other', otherTotal]);
            }

            charts.language = new Chart(document.getElementById('languageChart'), {
                type: 'doughnut',
                data: {
                    labels: chartData.map(([l]) => l),
                    datasets: [{
                        data: chartData.map(([, v]) => v),
                        backgroundColor: chartData.map(([l]) => l === 'Other' ? '#4b5563' : (LANG_COLORS[l] || '#6b7280'))
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: '#94a3b8', font: { size: 10 } } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label;
                                    const value = context.parsed;
                                    const pct = ((value / totalLoc) * 100).toFixed(1);

                                    if (label === 'Other' && otherLangs.length > 0) {
                                        // Show breakdown for "Other"
                                        const lines = [`Other: ${value.toLocaleString()} (${pct}%)`];
                                        otherLangs.forEach(([lang, loc, langPct]) => {
                                            lines.push(`  ${lang}: ${loc.toLocaleString()} (${langPct}%)`);
                                        });
                                        return lines;
                                    }
                                    return `${label}: ${value.toLocaleString()} (${pct}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // Growth Chart - Stacked by repo
            const locByRepo = getFilteredLocHistory();
            const REPO_COLORS = [
                '#8b5cf6', '#10b981', '#f59e0b', '#ef4444', '#3b82f6',
                '#ec4899', '#14b8a6', '#f97316', '#6366f1', '#84cc16',
                '#06b6d4', '#a855f7', '#22c55e', '#eab308'
            ];

            if (locByRepo && locByRepo.repos && locByRepo.repos.length > 0) {
                const datasets = locByRepo.repos.map((repo, idx) => ({
                    label: repo.name,
                    data: repo.data,
                    backgroundColor: REPO_COLORS[idx % REPO_COLORS.length] + '80',
                    borderColor: REPO_COLORS[idx % REPO_COLORS.length],
                    borderWidth: 1,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4,
                    pointHitRadius: 15,
                    pointHoverRadius: 6
                }));

                charts.growth = new Chart(document.getElementById('growthChart'), {
                    type: 'line',
                    data: {
                        labels: locByRepo.months,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: currentFilters.repo === 'all',
                                position: 'bottom',
                                labels: { color: '#94a3b8', font: { size: 9 }, boxWidth: 12 }
                            },
                            tooltip: {
                                mode: 'nearest',
                                intersect: true,
                                callbacks: {
                                    title: (items) => {
                                        if (items.length === 0) return '';
                                        return `${items[0].dataset.label} - ${items[0].label}`;
                                    },
                                    label: (item) => {
                                        return `Lines of Code: ${item.parsed.y.toLocaleString()}`;
                                    },
                                    afterLabel: (item) => {
                                        const project = dashboardData.projects.find(p => p.name === item.dataset.label);
                                        if (!project || !project.loc) return '';
                                        const langs = Object.entries(project.loc).sort((a, b) => b[1] - a[1]).slice(0, 4);
                                        if (langs.length === 0) return '';
                                        const total = Object.values(project.loc).reduce((a, b) => a + b, 0);
                                        return '\n' + langs.map(([l, c]) => `${l}: ${((c/total)*100).toFixed(0)}%`).join(', ');
                                    }
                                }
                            }
                        },
                        scales: {
                            x: { stacked: true, ticks: { color: '#475569' } },
                            y: {
                                stacked: true,
                                ticks: { color: '#475569', callback: v => (v/1000).toFixed(0) + 'k' }
                            }
                        }
                    }
                });
            } else {
                // Fallback to simple line chart if no per-repo data
                const locHist = dashboardData.loc_history || [];
                const monthsToShow = currentFilters.growthMonths;
                const filteredLocHist = locHist.slice(-monthsToShow);
                charts.growth = new Chart(document.getElementById('growthChart'), {
                    type: 'line',
                    data: {
                        labels: filteredLocHist.map(d => d.month),
                        datasets: [{ label: 'LOC', data: filteredLocHist.map(d => d.loc), borderColor: '#8b5cf6', backgroundColor: 'rgba(139, 92, 246, 0.1)', fill: true, tension: 0.4 }]
                    },
                    options: { responsive: true, plugins: { legend: { display: false } }, scales: { x: { ticks: { color: '#475569' } }, y: { ticks: { color: '#475569', callback: v => (v/1000).toFixed(0) + 'k' } } } }
                });
            }
        }

        function renderProjectCards() {
            const projects = getFilteredProjects();
            document.getElementById('project-cards').innerHTML = projects.map(p => {
                const totalLoc = Object.values(p.loc || {}).reduce((a, b) => a + b, 0);
                const color = LANG_COLORS[p.language] || '#6b7280';
                return `
                <div class="bg-slate-900/50 border border-slate-800/50 rounded-xl p-5 hover:border-emerald-500/30 transition-all cursor-pointer" onclick="showProjectDetail('${p.name}')">
                    <div class="flex items-start justify-between mb-3">
                        <div>
                            <h4 class="font-medium text-slate-200 hover:text-emerald-400 transition-colors">${p.name}</h4>
                            <p class="text-xs text-slate-500 mt-0.5">${p.description || ''}</p>
                        </div>
                        <span class="text-xs px-2 py-1 rounded-full" style="background: ${color}20; color: ${color}">${p.language}</span>
                    </div>
                    <div class="space-y-2">
                        <div class="flex items-center justify-between text-xs">
                            <span class="text-slate-500">Progress</span>
                            <span class="text-emerald-400">${p.progress || 0}%</span>
                        </div>
                        <div class="h-1.5 bg-slate-800 rounded-full overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-emerald-500 to-cyan-500 rounded-full" style="width: ${p.progress || 0}%"></div>
                        </div>
                        <div class="flex items-center justify-between text-xs text-slate-600 pt-1">
                            <span>${p.commits || 0} commits</span>
                            <span>${totalLoc.toLocaleString()} lines</span>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function getLatestRelease(repoName) {
            const releases = dashboardData.releases || [];
            const repoReleases = releases.filter(r => r.repo === repoName);
            if (repoReleases.length === 0) return null;
            // Sort by date descending and return the latest
            repoReleases.sort((a, b) => new Date(b.date) - new Date(a.date));
            return repoReleases[0];
        }

        function renderProjectsList() {
            const projects = dashboardData.projects || [];
            document.getElementById('projects-list').innerHTML = projects.map(p => {
                const totalLoc = Object.values(p.loc || {}).reduce((a, b) => a + b, 0);
                const color = LANG_COLORS[p.language] || '#6b7280';
                const latestRelease = getLatestRelease(p.name);
                const releaseHtml = latestRelease
                    ? `<a href="${getReleaseUrl(p.name, latestRelease.tag)}" target="_blank" onclick="event.stopPropagation()" class="text-amber-400 hover:text-amber-300">${latestRelease.tag}</a>`
                    : '<span class="text-slate-600">‚Äî</span>';
                return `
                <div class="bg-slate-900/50 border border-slate-800/50 rounded-xl p-6 hover:border-emerald-500/30 transition-all cursor-pointer" onclick="showProjectDetail('${p.name}')">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-lg flex items-center justify-center" style="background: ${color}15">
                                <svg class="w-6 h-6" style="color: ${color}" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="font-medium text-slate-200">${p.name}</h3>
                                <p class="text-sm text-slate-500">${p.description || ''}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-8">
                            <div class="text-right"><p class="text-2xl font-bold text-emerald-400">${p.progress || 0}%</p><p class="text-xs text-slate-500">progress</p></div>
                            <div class="text-right"><p class="text-lg font-medium text-slate-300">${p.commits || 0}</p><p class="text-xs text-slate-500">commits</p></div>
                            <div class="text-right"><p class="text-lg font-medium text-slate-300">${totalLoc.toLocaleString()}</p><p class="text-xs text-slate-500">lines</p></div>
                            <div class="text-right w-20"><p class="text-lg font-medium">${releaseHtml}</p><p class="text-xs text-slate-500">release</p></div>
                        </div>
                    </div>
                    <div class="mt-4"><div class="h-1.5 bg-slate-800 rounded-full overflow-hidden"><div class="h-full bg-gradient-to-r from-emerald-500 to-cyan-500 rounded-full" style="width: ${p.progress || 0}%"></div></div></div>
                </div>`;
            }).join('');
        }

        function showProjectDetail(name) {
            const p = dashboardData.projects.find(x => x.name === name);
            if (!p) return;
            
            const detail = document.getElementById('project-detail');
            const list = document.getElementById('projects-list');
            const totalLoc = Object.values(p.loc || {}).reduce((a, b) => a + b, 0);
            const color = LANG_COLORS[p.language] || '#6b7280';
            const goals = p.goals || [];
            const completedGoals = p.completed_goals || [];
            
            detail.innerHTML = `
                <button onclick="hideProjectDetail()" class="text-sm text-slate-500 hover:text-emerald-400 transition-colors mb-4">‚Üê Back to all projects</button>
                <div class="bg-slate-900/50 border border-slate-800/50 rounded-xl p-8">
                    <div class="flex items-start justify-between mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-100">${p.name}</h2>
                            <p class="text-slate-400 mt-1">${p.description || ''}</p>
                            ${p.url ? `<a href="${p.url}" target="_blank" class="text-xs text-emerald-400 hover:underline mt-2 inline-block">View on GitHub ‚Üí</a>` : ''}
                        </div>
                        <span class="text-xs px-3 py-1.5 rounded-full" style="background: ${color}20; color: ${color}">${p.language}</span>
                    </div>
                    <div class="grid grid-cols-3 gap-6 mb-8">
                        <div class="bg-slate-800/30 rounded-lg p-4"><p class="text-xs text-slate-500 uppercase">Progress</p><p class="text-3xl font-bold text-emerald-400 mt-1">${p.progress || 0}%</p></div>
                        <div class="bg-slate-800/30 rounded-lg p-4"><p class="text-xs text-slate-500 uppercase">Commits</p><p class="text-3xl font-bold text-cyan-400 mt-1">${p.commits || 0}</p></div>
                        <div class="bg-slate-800/30 rounded-lg p-4"><p class="text-xs text-slate-500 uppercase">Lines of Code</p><p class="text-3xl font-bold text-violet-400 mt-1">${totalLoc.toLocaleString()}</p></div>
                    </div>
                    <div class="grid grid-cols-2 gap-8">
                        <div>
                            <h3 class="text-sm font-medium text-slate-400 mb-4">Project Goals</h3>
                            <div class="space-y-2">
                                ${goals.length ? goals.map(g => {
                                    const done = completedGoals.includes(g);
                                    return `<div class="flex items-center gap-3 p-3 rounded-lg ${done ? 'bg-emerald-500/10 border border-emerald-500/20' : 'bg-slate-800/30'}">
                                        <div class="w-4 h-4 rounded-full flex items-center justify-center ${done ? 'bg-emerald-500' : 'border border-slate-600'}">${done ? '<span class="text-white text-xs">‚úì</span>' : ''}</div>
                                        <span class="${done ? 'text-emerald-300' : 'text-slate-400'}">${g}</span>
                                    </div>`;
                                }).join('') : '<p class="text-slate-500 text-sm">No goals defined. Edit projects_config.json to add goals.</p>'}
                            </div>
                        </div>
                        <div>
                            <h3 class="text-sm font-medium text-slate-400 mb-4">Code Breakdown</h3>
                            <div class="space-y-3">
                                ${Object.entries(p.loc || {}).sort((a, b) => b[1] - a[1]).map(([lang, lines]) => {
                                    const pct = totalLoc > 0 ? (lines / totalLoc * 100).toFixed(1) : 0;
                                    const langColor = LANG_COLORS[lang] || '#6b7280';
                                    return `<div>
                                        <div class="flex items-center justify-between text-sm mb-1"><span class="text-slate-300">${lang}</span><span class="text-slate-500">${lines.toLocaleString()} (${pct}%)</span></div>
                                        <div class="h-2 bg-slate-800 rounded-full overflow-hidden"><div class="h-full rounded-full" style="width: ${pct}%; background: ${langColor}"></div></div>
                                    </div>`;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                </div>`;
            list.classList.add('hidden');
            detail.classList.remove('hidden');
        }

        function hideProjectDetail() {
            document.getElementById('projects-list').classList.remove('hidden');
            document.getElementById('project-detail').classList.add('hidden');
        }

        function renderCalendar() {
            const hist = getFilteredCommitHistory();
            document.getElementById('contribution-calendar').innerHTML = hist.map(d => {
                const commits = d.commits || 0;
                const colors = ['bg-slate-800', 'bg-emerald-900', 'bg-emerald-700', 'bg-emerald-500', 'bg-emerald-400'];
                const intensity = commits === 0 ? 0 : commits <= 2 ? 1 : commits <= 4 ? 2 : commits <= 6 ? 3 : 4;
                return `<div class="w-3 h-3 rounded-sm ${colors[intensity]} hover:ring-1 hover:ring-emerald-400 cursor-pointer" title="${d.date}: ${commits} commits"></div>`;
            }).join('');
        }

        function renderActivity() {
            const projects = dashboardData.projects || [];
            document.getElementById('recent-activity').innerHTML = projects.map(p => {
                const lastCommit = p.last_commit ? new Date(p.last_commit) : null;
                const timeAgo = lastCommit ? formatTimeAgo(lastCommit) : 'Unknown';
                return `
                <div class="flex items-center justify-between p-3 bg-slate-800/30 rounded-lg">
                    <div class="flex items-center gap-3">
                        <div class="w-2 h-2 rounded-full bg-emerald-400"></div>
                        <span class="text-slate-300">${p.name}</span>
                    </div>
                    <div class="flex items-center gap-4 text-sm text-slate-500">
                        <span>${timeAgo}</span>
                        <span class="text-emerald-400">${p.commits || 0} commits</span>
                    </div>
                </div>`;
            }).join('');
        }

        function formatTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return 'just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)} min ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)} hours ago`;
            if (seconds < 604800) return `${Math.floor(seconds / 86400)} days ago`;
            return date.toLocaleDateString();
        }

        function formatReleaseDate(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diffMs = now - date;
            const diffDays = diffMs / (1000 * 60 * 60 * 24);
            const diffYears = diffMs / (1000 * 60 * 60 * 24 * 365);

            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

            // Check if same calendar day
            const isToday = date.toDateString() === now.toDateString();

            if (isToday) {
                // Today: show time
                return date.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
            } else if (diffDays < 7) {
                // Within past 7 days: show day of week
                return days[date.getDay()];
            } else if (diffYears < 1) {
                // Within past year: show day-mon
                return `${date.getDate()} ${months[date.getMonth()]}`;
            } else {
                // Older: show day-mon-year
                return `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()}`;
            }
        }

        function getRepoUrl(repoName) {
            const project = (dashboardData.projects || []).find(p => p.name === repoName);
            let url = project?.url || '';

            // Convert SSH URL to HTTPS if needed
            if (url.startsWith('git@github.com:')) {
                url = 'https://github.com/' + url.replace('git@github.com:', '').replace('.git', '');
            } else if (url && !url.startsWith('http')) {
                // Fallback for other formats
                url = `https://github.com/Rick-Wilson/${repoName}`;
            } else if (!url) {
                url = `https://github.com/Rick-Wilson/${repoName}`;
            }

            return url;
        }

        function getReleaseUrl(repoName, tag) {
            const repoUrl = getRepoUrl(repoName);
            return `${repoUrl}/releases/tag/${tag}`;
        }

        function showTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(el => {
                el.classList.remove('bg-emerald-500/20', 'text-emerald-400', 'border', 'border-emerald-500/30');
                el.classList.add('text-slate-400', 'hover:text-slate-200', 'hover:bg-slate-800/50');
            });
            document.getElementById('tab-' + tab).classList.remove('hidden');
            const btn = document.querySelector(`[data-tab="${tab}"]`);
            btn.classList.add('bg-emerald-500/20', 'text-emerald-400', 'border', 'border-emerald-500/30');
            btn.classList.remove('text-slate-400', 'hover:text-slate-200', 'hover:bg-slate-800/50');
            updateUrlParams(tab);
        }

        // Claude Tab Rendering
        function renderClaudeTab() {
            if (!claudeData) {
                document.getElementById('claude-stats-grid').innerHTML = `
                    <div class="col-span-4 text-center py-12">
                        <p class="text-slate-500">Claude stats not available</p>
                        <p class="text-xs text-slate-600 mt-2">Place claude_stats.json in the dashboard directory</p>
                    </div>`;
                return;
            }

            renderClaudeStats();
            renderClaudeActivityChart();
            renderClaudeHeatmap();
            renderClaudeHourlyChart();
        }

        function renderClaudeStats() {
            const stats = claudeData;
            const totalTokens = Object.values(stats.modelUsage || {}).reduce((sum, m) => {
                return sum + (m.inputTokens || 0) + (m.outputTokens || 0) +
                       (m.cacheReadInputTokens || 0) + (m.cacheCreationInputTokens || 0);
            }, 0);

            // Calculate recent activity - use userPrompts
            const recentActivity = (stats.dailyActivity || []).slice(-7);
            const thisWeekPrompts = recentActivity.reduce((sum, d) => sum + (d.userPrompts || 0), 0);
            const thisWeekSessions = recentActivity.reduce((sum, d) => sum + (d.sessionCount || 0), 0);

            // Format first session date
            const firstDate = stats.firstSessionDate ? new Date(stats.firstSessionDate).toLocaleDateString() : 'N/A';

            // Get primary model
            const models = Object.keys(stats.modelUsage || {});
            const primaryModel = models.length > 0 ? models[models.length - 1].split('-').slice(1, 3).join(' ') : 'N/A';

            document.getElementById('claude-stats-grid').innerHTML = `
                <div class="bg-slate-900/50 border border-slate-800/50 rounded-xl p-5 hover:border-violet-500/30 transition-all">
                    <p class="text-xs text-slate-500 uppercase tracking-wider">Total Sessions</p>
                    <p class="text-3xl font-bold mt-1 text-violet-400">${(stats.totalSessions || 0).toLocaleString()}</p>
                    <p class="text-xs text-slate-600 mt-1">+${thisWeekSessions} this week</p>
                </div>
                <div class="bg-slate-900/50 border border-slate-800/50 rounded-xl p-5 hover:border-fuchsia-500/30 transition-all">
                    <p class="text-xs text-slate-500 uppercase tracking-wider">User Prompts</p>
                    <p class="text-3xl font-bold mt-1 text-fuchsia-400">${(stats.totalUserPrompts || 0).toLocaleString()}</p>
                    <p class="text-xs text-slate-600 mt-1">+${thisWeekPrompts.toLocaleString()} this week</p>
                </div>
                <div class="bg-slate-900/50 border border-slate-800/50 rounded-xl p-5 hover:border-pink-500/30 transition-all">
                    <p class="text-xs text-slate-500 uppercase tracking-wider">Total Tokens</p>
                    <p class="text-3xl font-bold mt-1 text-pink-400">${formatTokens(totalTokens)}</p>
                    <p class="text-xs text-slate-600 mt-1">${primaryModel}</p>
                </div>
                <div class="bg-slate-900/50 border border-slate-800/50 rounded-xl p-5 hover:border-indigo-500/30 transition-all">
                    <p class="text-xs text-slate-500 uppercase tracking-wider">Since</p>
                    <p class="text-2xl font-bold mt-1 text-indigo-400">${firstDate}</p>
                    <p class="text-xs text-slate-600 mt-1">${calculateDaysSince(stats.firstSessionDate)} days</p>
                </div>
            `;
        }

        function formatTokens(tokens) {
            if (tokens >= 1e9) return (tokens / 1e9).toFixed(1) + 'B';
            if (tokens >= 1e6) return (tokens / 1e6).toFixed(1) + 'M';
            if (tokens >= 1e3) return (tokens / 1e3).toFixed(1) + 'K';
            return tokens.toString();
        }

        function calculateDaysSince(dateStr) {
            if (!dateStr) return 0;
            const start = new Date(dateStr);
            const now = new Date();
            return Math.floor((now - start) / (1000 * 60 * 60 * 24));
        }

        function renderClaudeActivityChart() {
            const activity = claudeData.dailyActivity || [];
            if (activity.length === 0) return;

            if (charts.claudeActivity) charts.claudeActivity.destroy();

            charts.claudeActivity = new Chart(document.getElementById('claudeActivityChart'), {
                type: 'line',
                data: {
                    labels: activity.map(d => d.date.slice(5)),
                    datasets: [
                        {
                            label: 'User Prompts',
                            data: activity.map(d => d.userPrompts || 0),
                            borderColor: '#a855f7',
                            backgroundColor: 'rgba(168, 85, 247, 0.1)',
                            fill: true,
                            tension: 0.4,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Tool Calls',
                            data: activity.map(d => d.toolCallCount || 0),
                            borderColor: '#ec4899',
                            backgroundColor: 'rgba(236, 72, 153, 0.1)',
                            fill: true,
                            tension: 0.4,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Sessions',
                            data: activity.map(d => d.sessionCount || 0),
                            borderColor: '#6366f1',
                            backgroundColor: 'rgba(99, 102, 241, 0.1)',
                            fill: false,
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#94a3b8', font: { size: 10 } }
                        }
                    },
                    scales: {
                        x: { ticks: { color: '#475569', maxTicksLimit: 15 } },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'Prompts / Tool Calls', color: '#94a3b8', font: { size: 10 } },
                            ticks: { color: '#475569' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: { display: true, text: 'Sessions', color: '#94a3b8', font: { size: 10 } },
                            grid: { drawOnChartArea: false },
                            ticks: { color: '#475569' }
                        }
                    }
                }
            });
        }

        function renderClaudeHeatmap() {
            const activity = claudeData.dailyActivity || [];
            if (activity.length === 0) return;

            // Group by month - use userPrompts
            const monthlyData = {};
            activity.forEach(d => {
                const date = new Date(d.date);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                const dayOfMonth = date.getDate();

                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = {
                        year: date.getFullYear(),
                        month: date.getMonth(),
                        days: {}
                    };
                }
                monthlyData[monthKey].days[dayOfMonth] = d.userPrompts || 0;
            });

            // Find max prompts for scaling
            const maxPrompts = Math.max(...activity.map(d => d.userPrompts || 0));

            // Generate heatmap HTML
            const months = Object.keys(monthlyData).sort();
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

            const today = new Date();
            const todayYear = today.getFullYear();
            const todayMonth = today.getMonth();
            const todayDay = today.getDate();

            let html = '<div class="space-y-3">';
            months.forEach(monthKey => {
                const data = monthlyData[monthKey];
                const daysInMonth = new Date(data.year, data.month + 1, 0).getDate();
                const monthName = monthNames[data.month];

                html += `<div class="flex items-center gap-3">`;
                html += `<span class="text-xs text-slate-500 w-12">${monthName} ${data.year.toString().slice(2)}</span>`;
                html += `<div class="flex gap-1 flex-wrap">`;

                for (let day = 1; day <= daysInMonth; day++) {
                    // Skip future days
                    if (data.year > todayYear ||
                        (data.year === todayYear && data.month > todayMonth) ||
                        (data.year === todayYear && data.month === todayMonth && day > todayDay)) {
                        continue;
                    }

                    const prompts = data.days[day] || 0;
                    const intensity = prompts === 0 ? 0 :
                        prompts <= maxPrompts * 0.2 ? 1 :
                        prompts <= maxPrompts * 0.4 ? 2 :
                        prompts <= maxPrompts * 0.6 ? 3 : 4;
                    const colors = ['bg-slate-800', 'bg-violet-900', 'bg-violet-700', 'bg-violet-500', 'bg-violet-400'];
                    const dateStr = `${data.year}-${String(data.month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

                    html += `<div class="w-3 h-3 rounded-sm ${colors[intensity]} hover:ring-1 hover:ring-violet-400 cursor-pointer" title="${dateStr}: ${prompts.toLocaleString()} prompts"></div>`;
                }

                html += `</div></div>`;
            });
            html += '</div>';

            document.getElementById('claude-heatmap').innerHTML = html;
        }

        function renderClaudeHourlyChart() {
            const hourCounts = claudeData.hourCounts || {};
            if (Object.keys(hourCounts).length === 0) return;

            // Fill in all hours 0-23
            const hours = [];
            const counts = [];
            for (let h = 0; h < 24; h++) {
                hours.push(h.toString().padStart(2, '0') + ':00');
                counts.push(hourCounts[h] || 0);
            }

            if (charts.claudeHourly) charts.claudeHourly.destroy();

            charts.claudeHourly = new Chart(document.getElementById('claudeHourlyChart'), {
                type: 'bar',
                data: {
                    labels: hours,
                    datasets: [{
                        label: 'User Prompts',
                        data: counts,
                        backgroundColor: 'rgba(139, 92, 246, 0.6)',
                        borderColor: '#8b5cf6',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: { ticks: { color: '#475569', maxTicksLimit: 12 } },
                        y: { ticks: { color: '#475569' } }
                    }
                }
            });
        }

        // Initialize
        initFiltersFromUrl();
        loadData();
    </script>
</body>
</html>
